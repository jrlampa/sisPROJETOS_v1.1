name: Continuous Integration

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
      
      - name: Run flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 src/ --count --exit-zero --max-complexity=15 --max-line-length=119 --statistics
      
      - name: Check formatting with black
        run: |
          black src/ --check --line-length 119
      
      - name: Check import order with isort
        run: |
          isort src/ --check --profile black

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      
      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report-${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 7

  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
      - name: Run Bandit (Security linter)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll
      
      - name: Check dependencies with Safety
        run: |
          safety check --json || true
          safety check
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  dependency-check:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Check for outdated dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip list --outdated

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install radon complexity
      
      - name: Calculate cyclomatic complexity
        run: |
          radon cc src/ -a -s
      
      - name: Calculate maintainability index
        run: |
          radon mi src/ -s

  coverage-report:
    name: Coverage Report
    needs: test-windows
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: code-coverage-report-3.12
      
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-sisPROJETOS
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  notify-status:
    name: Notify Build Status
    needs: [lint, test-windows, test-linux, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check overall status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test Windows: ${{ needs.test-windows.result }}"
          echo "Test Linux: ${{ needs.test-linux.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test-windows.result }}" == "failure" ]] || \
             [[ "${{ needs.test-linux.result }}" == "failure" ]]; then
            echo "❌ CI Failed"
            exit 1
          else
            echo "✅ CI Passed"
          fi
