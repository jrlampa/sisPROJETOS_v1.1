name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.0.1)'
        required: true

jobs:
  build:
    name: Build Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      working-directory: sisPROJETOS_revived
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Run tests before build
      working-directory: sisPROJETOS_revived
      run: |
        pip install pytest
        pytest tests/ -v
    
    - name: Build executable with PyInstaller
      working-directory: sisPROJETOS_revived
      run: |
        # Check if .spec file exists (case-insensitive check)
        if (Test-Path "sisprojetos.spec") {
          Write-Host "Building with sisprojetos.spec..."
          python -m PyInstaller sisprojetos.spec --clean --noconfirm
        } else {
          Write-Host "Spec file not found, using basic build..."
          # Basic build if no spec file
          pyinstaller --onefile --windowed --name sisPROJETOS run.py
        }
    
    - name: Validate build output
      working-directory: sisPROJETOS_revived
      run: |
        # Check if executable was created
        if (Test-Path "dist\sisPROJETOS\sisPROJETOS.exe") {
          Write-Host "‚úì Executable created successfully" -ForegroundColor Green
          $fileSize = (Get-Item "dist\sisPROJETOS\sisPROJETOS.exe").Length / 1MB
          Write-Host "  Size: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Error "Build failed: Executable not found!"
          exit 1
        }
        
        # Count files in distribution
        $fileCount = (Get-ChildItem -Path "dist\sisPROJETOS" -Recurse -File).Count
        Write-Host "  Total files: $fileCount"
        
        # Check for required resources
        $requiredPaths = @(
          "dist\sisPROJETOS\resources\templates",
          "dist\sisPROJETOS\modules\catenaria\resources"
        )
        foreach ($path in $requiredPaths) {
          if (Test-Path $path) {
            Write-Host "‚úì Found: $path" -ForegroundColor Green
          } else {
            Write-Warning "Missing: $path"
          }
        }
    
    - name: Get version tag
      id: get_version
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          echo "VERSION=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
        } else {
          echo "VERSION=${env:GITHUB_REF_NAME}" >> $env:GITHUB_OUTPUT
        }
    
    - name: Create release archive
      working-directory: sisPROJETOS_revived
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        
        # Create portable ZIP archive
        Write-Host "Creating portable archive..."
        Compress-Archive -Path dist\sisPROJETOS\* -DestinationPath "sisPROJETOS-$version-Windows-Portable.zip"
        
        # Create full distribution ZIP (includes dist folder structure)
        Write-Host "Creating full distribution archive..."
        Compress-Archive -Path dist\* -DestinationPath "sisPROJETOS-$version-Windows-Full.zip"
        
        # Calculate checksums
        Write-Host "Calculating checksums..."
        $portableHash = (Get-FileHash "sisPROJETOS-$version-Windows-Portable.zip" -Algorithm SHA256).Hash
        $fullHash = (Get-FileHash "sisPROJETOS-$version-Windows-Full.zip" -Algorithm SHA256).Hash
        
        # Save checksums to file
        @"
        SHA256 Checksums for sisPROJETOS $version
        =========================================
        sisPROJETOS-$version-Windows-Portable.zip
        $portableHash
        
        sisPROJETOS-$version-Windows-Full.zip
        $fullHash
        "@ | Out-File -FilePath "checksums.txt" -Encoding UTF8
        
        Write-Host "Build artifacts created successfully:" -ForegroundColor Green
        Get-ChildItem -Filter "sisPROJETOS-*.zip" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Host "  - $($_.Name) ($([math]::Round($size, 2)) MB)"
        }
    
    - name: Try building installer with Inno Setup (optional)
      working-directory: sisPROJETOS_revived
      continue-on-error: true
      run: |
        # Check if Inno Setup is available
        $innoSetupPaths = @(
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe",
          "C:\Program Files\Inno Setup 6\ISCC.exe",
          "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe",
          "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
        )
        
        $innoSetupExe = $null
        foreach ($path in $innoSetupPaths) {
          if (Test-Path $path) {
            $innoSetupExe = $path
            break
          }
        }
        
        if ($innoSetupExe -and (Test-Path "sisPROJETOS.iss")) {
          Write-Host "Inno Setup found at: $innoSetupExe" -ForegroundColor Green
          Write-Host "Building installer..."
          & $innoSetupExe "sisPROJETOS.iss"
          
          if (Test-Path "installer_output") {
            Write-Host "Installer created successfully!" -ForegroundColor Green
            Get-ChildItem -Path "installer_output" -Filter "*.exe" | ForEach-Object {
              $size = $_.Length / 1MB
              Write-Host "  - $($_.Name) ($([math]::Round($size, 2)) MB)"
            }
          }
        } else {
          Write-Host "Inno Setup not available or .iss file not found - skipping installer generation" -ForegroundColor Yellow
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: sisPROJETOS-Windows-${{ steps.get_version.outputs.VERSION }}
        path: |
          sisPROJETOS_revived/sisPROJETOS-*.zip
          sisPROJETOS_revived/checksums.txt
          sisPROJETOS_revived/installer_output/*.exe
        if-no-files-found: warn
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          sisPROJETOS_revived/sisPROJETOS-*.zip
          sisPROJETOS_revived/checksums.txt
          sisPROJETOS_revived/installer_output/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üì¶ sisPROJETOS ${{ steps.get_version.outputs.VERSION }}
          
          Sistema de Engenharia e Projetos para dimensionamento de redes el√©tricas.
          
          ### üì• Download
          
          **Instalador (Recomendado):**
          - `sisPROJETOS_v${{ steps.get_version.outputs.VERSION }}_Setup.exe` - Instalador completo para Windows
          
          **Vers√£o Port√°til:**
          - `sisPROJETOS-${{ steps.get_version.outputs.VERSION }}-Windows-Portable.zip` - Extrair e executar `sisPROJETOS.exe`
          - `sisPROJETOS-${{ steps.get_version.outputs.VERSION }}-Windows-Full.zip` - Distribui√ß√£o completa com estrutura de pastas
          
          **Checksums:**
          - `checksums.txt` - Hashes SHA256 para verifica√ß√£o de integridade
          
          ### üìã Changelog
          
          Veja [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/sisPROJETOS_revived/CHANGELOG.md) para detalhes completos das mudan√ßas.
          
          ### üöÄ Instala√ß√£o
          
          **Op√ß√£o 1 - Instalador (Recomendado):**
          1. Baixe o arquivo `sisPROJETOS_v${{ steps.get_version.outputs.VERSION }}_Setup.exe`
          2. Execute o instalador e siga as instru√ß√µes
          3. O aplicativo ser√° instalado em `%LOCALAPPDATA%\sisPROJETOS`
          
          **Op√ß√£o 2 - Vers√£o Port√°til:**
          1. Baixe o arquivo `sisPROJETOS-${{ steps.get_version.outputs.VERSION }}-Windows-Portable.zip`
          2. Extraia o conte√∫do para uma pasta de sua escolha
          3. Execute `sisPROJETOS.exe`
          
          ### ‚öôÔ∏è Requisitos do Sistema
          
          - **Sistema Operacional:** Windows 10/11 (64-bit)
          - **Mem√≥ria RAM:** M√≠nimo 4 GB (recomendado 8 GB)
          - **Espa√ßo em Disco:** ~300 MB
          - **Depend√™ncias:** Nenhuma (todas inclu√≠das no execut√°vel)
          
          ### ‚úÖ Verifica√ß√µes
          
          - ‚úÖ Testes automatizados passando
          - ‚úÖ Build autom√°tico via GitHub Actions
          - ‚úÖ Vers√£o verificada
          - ‚úÖ Checksums SHA256 inclu√≠dos
          
          ### üìù Notas
          
          - Os dados do projeto s√£o salvos em `%APPDATA%\sisPROJETOS`
          - Configura√ß√µes s√£o preservadas entre atualiza√ß√µes
          - Para relatar problemas, use a [p√°gina de Issues](https://github.com/${{ github.repository }}/issues)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Send notification
      run: |
        echo "Release ${{ github.ref_name }} criada com sucesso!"
        echo "Download dispon√≠vel em: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
